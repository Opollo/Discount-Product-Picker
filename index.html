<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QUEENS AND KINGS t</title>
  <style>
    :root {
      --primary: #4f46e5;
      --success: #10b981;
      --danger: #ef4444;
      --bg: #f8fafc;
      --text: #1e293b;
      --border: #e2e8f0;
      --card: #ffffff;
      --best-buy: #fbbf24;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: "Segoe UI", sans-serif;
      background: var(--bg); color: var(--text);
      display: flex; flex-direction: column; height: 100vh;
    }
    header {
      background: var(--primary); color: white;
      padding: 1rem; text-align: center; font-weight: 600;
      letter-spacing: 0.5px;
    }
    #chat-container {
      flex: 1; overflow-y: auto; padding: 1rem;
      display: flex; flex-direction: column; gap: 1rem;
    }
    .message {
      max-width: 80%; padding: 0.75rem 1rem; border-radius: 1rem;
      line-height: 1.5; animation: fadeIn 0.3s ease;
    }
    .user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 0.3rem; }
    .bot { align-self: flex-start; background: var(--card); border: 1px solid var(--border); border-bottom-left-radius: 0.3rem; }
    @keyframes fadeIn { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }
    .product-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem; margin-top: 1rem;
    }
    .product-card {
      border: 1px solid var(--border); border-radius: 0.75rem;
      background: white; text-align: center; overflow: hidden;
      transition: transform 0.2s ease; position: relative;
    }
    .product-card:hover { transform: scale(1.02); }
    .product-card img { width: 100%; height: 150px; object-fit: cover; }
    .product-card h4 { margin: 0.5rem; font-size: 1rem; color: var(--text); }
    .price { color: #e91e63; font-weight: 600; }
    .original-price { text-decoration: line-through; color: #94a3b8; font-size: 0.85rem; }
    .discount-badge {
      position: absolute; top: 8px; right: 8px; background: var(--danger); color: white;
      font-size: 0.75rem; font-weight: bold; padding: 4px 8px; border-radius: 1rem;
    }
    .best-buy-badge {
      background: var(--best-buy); color: #1e293b; animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    .trend-chart { width: 100%; height: 200px; margin-top: 1rem; }
    #input-area {
      display: flex; padding: 1rem; gap: 0.5rem;
      background: white; border-top: 1px solid var(--border);
    }
    #user-input {
      flex: 1; padding: 0.75rem; border: 1px solid var(--border);
      border-radius: 0.5rem; font-size: 1rem;
    }
    button {
      padding: 0.75rem 1rem; border: none; border-radius: 0.5rem;
      font-weight: 600; cursor: pointer; transition: 0.2s;
    }
    #send-btn { background: var(--primary); color: white; }
    #mic-btn { background: var(--success); color: white; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .loading { font-style: italic; color: #64748b; }
    footer {
      text-align: center; padding: 0.5rem;
      font-size: 0.8rem; color: #94a3b8;
      border-top: 1px solid var(--border);
    }
  </style>
</head>

<body>
  <header>AI Shopping & Trends Chatbot</header>
  <div id="chat-container"></div>

  <div id="input-area">
    <input id="user-input" type="text" placeholder="Ask about products with 30%+ off..." />
    <button id="send-btn">Send</button>
    <button id="mic-btn" title="Speak">üé§</button>
  </div>

  <footer>Powered by Google Search, Amazon, & Trends APIs</footer>

  <script>
    // === CONFIG ===
    const BACKEND_URL = "http://localhost:5000";  // Your Flask backend

    const chat = document.getElementById("chat-container");
    const input = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const micBtn = document.getElementById("mic-btn");

    // === Speech Recognition ===
    let recognition;
    if ("SpeechRecognition" in window || "webkitSpeechRecognition" in window) {
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "en-US"; recognition.interimResults = false;
    }

    // === Chat UI Helpers ===
    const addMessage = (text, sender = "bot") => {
      const msg = document.createElement("div");
      msg.className = `message ${sender}`;
      msg.innerHTML = text;
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
    };

    const replaceLastMessage = html => chat.lastChild.innerHTML = html;

    // === Client-Side Discount Enrichment (for Amazon) ===
    function parseDiscount(snippet, title = "") {
      const text = `${title} ${snippet}`.toLowerCase();
      const patterns = [
        /was\s*\$\s*([\d,]+\.?\d*)\s*now\s*\$\s*([\d,]+\.?\d*)/,
        /\$?\s*([\d,]+\.?\d*)\s*[\‚Äì\-]\s*\$?\s*([\d,]+\.?\d*)/,
        /(\d+)%\s*off/,
        /save\s*(\d+)%/,
        /now\s*\$?\s*([\d,]+\.?\d*)\s*\(was\s*\$?\s*([\d,]+\.?\d*)\)/
      ];

      for (const pattern of patterns) {
        const match = text.match(pattern);
        if (match) {
          if (match[0].includes('%')) {
            const percent = parseInt(match[1]);
            if (percent >= 30) return { percent, type: 'percent' };
          } else if (match[1] && match[2]) {
            const original = parseFloat(match[1].replace(/,/g, ''));
            const current = parseFloat(match[2].replace(/,/g, ''));
            if (original > current) {
              const percent = Math.round(((original - current) / original) * 100);
              if (percent >= 30) return { percent, original, current, type: 'price' };
            }
          }
        }
      }
      return null;
    }

    // === Integrated Query Handling (via Backend) ===
    async function processQuery(query) {
      addMessage(`<span class="loading">Searching for deals ‚â•30% off...</span>`, "bot");
      try {
        // Fetch all via backend proxies
        const [searchRes, amazonRes, trendsRes] = await Promise.all([
          fetch(`${BACKEND_URL}/search?q=${encodeURIComponent(query)}`),
          fetch(`${BACKEND_URL}/amazon-search?q=${encodeURIComponent(query)}`),
          fetch(`${BACKEND_URL}/trends?q=${encodeURIComponent(query)}`)
        ]);

        const searchData = await searchRes.json();
        const amazonData = await amazonRes.json();
        const trendsData = await trendsRes.json();

        const searchResults = searchData.items || searchData;  // Handle both formats
        const products = amazonData.products || [];
        const trends = trendsData.timeline || [];

        let html = `<strong>üîé Web Insight:</strong> ${searchResults[0]?.snippet?.substring(0, 150) || "No results."}...<hr/>`;

        const allProducts = [...products];
        const bestBuys = searchData.best_buys || [];  // From backend discount parsing

        // Enrich Amazon products with client-side discount (if backend didn't)
        for (const p of products) {
          if (!p.discount) {
            const discount = parseDiscount(p.title + " " + (p.snippet || ""), p.title);
            p.discount = discount;
            if (discount && discount.percent >= 30) {
              bestBuys.push({ ...p, source: 'Amazon' });
            }
          }
        }

        // Scan Google snippets for additional deals (backend already filters, but enrich)
        for (const item of (searchResults.items || searchResults.slice(0, 10))) {
          if (item.discount && item.discount.percent >= 30 && !bestBuys.some(b => b.url === item.url)) {
            bestBuys.push({
              title: item.title.substring(0, 60),
              url: item.link || item.url,
              discount: item.discount,
              source: new URL(item.url || item.link).hostname,
              image: item.image || 'https://via.placeholder.com/200?text=Deal'
            });
          }
        }

        // === Display Best Buys First ===
        if (bestBuys.length > 0) {
          html += `<strong>üéâ BEST BUYS (‚â•30% OFF):</strong><div class="product-grid">`;
          for (const p of bestBuys.slice(0, 4)) {
            const badge = p.discount.percent ? `${p.discount.percent}% OFF` : 'SALE';
            html += `
              <div class="product-card">
                <img src="${p.image || 'https://via.placeholder.com/200'}" alt="${p.title}">
                <div class="discount-badge best-buy-badge">‚≠ê BEST BUY</div>
                <div class="discount-badge">${badge}</div>
                <h4>${p.title}...</h4>
                ${p.discount.original ? `
                  <div><span class="original-price">$${p.discount.original}</span> ‚Üí <span class="price">$${p.discount.current}</span></div>
                ` : `<div class="price">View Deal</div>`}
                <a href="${p.url}" target="_blank" style="font-size:0.8rem;color:#4f46e5;">Open ‚Üí</a>
              </div>`;
          }
          html += `</div><hr/>`;
        } else {
          html += `<em>No deals ‚â•30% off found. Try "laptops on sale", "iPhone discount", etc.</em><hr/>`;
        }

        // === Regular Products ===
        if (allProducts.length) {
          html += `<strong>üõí Other Products:</strong><div class="product-grid">`;
          for (const p of allProducts.slice(0, 4)) {
            if (bestBuys.some(b => b.url === p.url)) continue;
            html += `
              <div class="product-card">
                <img src="${p.image || 'https://via.placeholder.com/200'}" alt="${p.title}">
                <h4>${p.title.substring(0, 50)}...</h4>
                <div class="price">$${p.price || 'Check'}</div>
                <a href="${p.url}" target="_blank" style="font-size:0.8rem;color:#4f46e5;">View ‚Üí</a>
              </div>`;
          }
          html += `</div>`;
        }

        // === Other Deals from Search ===
        if (searchData.other_results && searchData.other_results.length > 0) {
          html += `<strong>üîç Other Deals:</strong>`;
          for (const item of searchData.other_results.slice(0, 4)) {
            html += `<div style="margin:1rem 0;"><strong>${item.title}</strong><br>${item.snippet}<br><a href="${item.url}" target="_blank">Link</a></div>`;
          }
        }

        if (trends.length > 1) {
          html += `<strong>üìà Trend (Last 7 Days):</strong><canvas id="trendChart" class="trend-chart"></canvas>`;
        }

        replaceLastMessage(html);
        if (trends.length > 1) drawTrendChart(trends);
      } catch (err) {
        // Fallback mock data
        replaceLastMessage(`<em>Using demo data (backend offline? Start with python main.py)</em><hr/>
          <div class="product-grid">
            <div class="product-card"><h4>Sample Laptop (35% OFF)</h4><div class="price">$649</div><a href="https://amazon.com">Buy</a></div>
            <div class="product-card"><h4>Earbuds (40% OFF)</h4><div class="price">$59</div><a href="https://amazon.com">Buy</a></div>
          </div>`);
        console.error(err);
      }
    }

    // === Draw Trend Chart ===
    function drawTrendChart(data) {
      const canvas = document.getElementById("trendChart");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      const w = canvas.width = canvas.parentElement.offsetWidth;
      const h = canvas.height = 200;
      ctx.clearRect(0, 0, w, h);
      const max = Math.max(...data.map(d => d.value)) * 1.2;

      ctx.strokeStyle = "#e2e8f0"; ctx.lineWidth = 1;
      for (let i = 0; i <= 5; i++) {
        const y = (h * i) / 5;
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
      }

      ctx.strokeStyle = "#4f46e5"; ctx.lineWidth = 3;
      ctx.beginPath();
      data.forEach((d, i) => {
        const x = (w * i) / (data.length - 1);
        const y = h - (h * d.value / max);
        i ? ctx.lineTo(x, y) : ctx.moveTo(x, y);
      });
      ctx.stroke();

      ctx.fillStyle = "#64748b"; ctx.font = "12px sans-serif";
      data.forEach((d, i) => ctx.fillText(d.date, (w * i) / (data.length - 1) - 10, h - 5));
    }

    // === Event Listeners ===
    sendBtn.onclick = () => {
      const q = input.value.trim();
      if (!q) return;
      addMessage(q, "user");
      input.value = "";
      processQuery(q);
    };
    input.onkeypress = e => e.key === "Enter" && sendBtn.click();

    micBtn.onclick = () => {
      if (!recognition) return alert("Speech recognition not supported.");
      micBtn.disabled = true; micBtn.textContent = "üéôÔ∏è";
      recognition.start();
    };

    if (recognition) {
      recognition.onresult = e => {
        const transcript = e.results[0][0].transcript;
        input.value = transcript;
        micBtn.disabled = false; micBtn.textContent = "üé§";
        sendBtn.click();  // Triggers processQuery via /search
      };
      recognition.onerror = () => { micBtn.disabled = false; micBtn.textContent = "üé§"; };
      recognition.onend = () => { micBtn.disabled = false; micBtn.textContent = "üé§"; };
    }

    // === Alternative: MediaRecorder for File-Based Speech (Uncomment for Upload to /speech) ===
    /*
    async function recordAudio() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(stream);
      const chunks = [];
      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/wav' });
        const base64 = await blobToBase64(blob);
        const res = await fetch(`${BACKEND_URL}/speech`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ audio: base64 })
        });
        const data = await res.json();
        processQuery(data.transcript);  // Or use data.search_results
      };
      mediaRecorder.start();
      setTimeout(() => mediaRecorder.stop(), 5000);  // 5s recording
    }
    function blobToBase64(blob) {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
      });
    }
    // Replace micBtn.onclick with: micBtn.onclick = recordAudio;
    */

    // === Welcome Message ===
    window.onload = () => addMessage(`
      <strong>Hello!</strong> üëã I'm your <em>Deal Hunter</em>.<br>
      I find products with <strong>30%+ OFF</strong> and mark them as <span style="color:#d97706;font-weight:bold">BEST BUY</span>!<br><br>
      Try: <em>"iPhone 15 discount"</em>, <em>"laptop 30% off"</em>, or tap üé§ to speak.
    `);
  </script>
</body>
</html>
